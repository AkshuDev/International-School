<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InterNational School</title>
    <link rel="icon" href="Assets/logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="./style.css" />
    <link rel="stylesheet" href="./login.css" />
  </head>
  <body>
    <div class="school-logo" style="display: block; align-items: center; text-align: align; justify-content: flex-start;">
      <a href="./index.html">
        <img src="./Assets/logo-highres.png" alt="School Logo" />
      </a>
    </div>
    <div class="container login-card">
      <form id="Login">
        <h2>Student Sign-Up</h2>
        <label for="username">Admission Number:</label>
        <input
          type="text"
          id="admissonNo"
          aria-required="true"
          placeholder="Enter your Admisson Number (Username)"
          autofocus
        />
        <label for="password">Password:</label>
        <input
          type="password"
          id="password"
          aria-required="true"
          placeholder="Set your Password"
        />
        <label for="password">Confirm Password:</label>
        <input
          type="password"
          id="confirm_password"
          aria-required="true"
          placeholder="Confirm your password"
        />
        <label for="phone">Phone Number:</label>
        <input
          type="tel"
          id="phone"
          aria-required="true"
          placeholder="Enter your Phone Number"
        />
        <p id="errorMessage" aria-live="assertive" aria-atomic="true" style="color: red; display: none;"></p>
        <div class="buttons">
          <button type="submit">Sign Up</button>
        </div>
        <div id="re-CAPTCHA"></div>
        <a href="./login.html" id="signUpLink"><p>Login</p></a>
      </form>
    </div>
    <script src="../BackEnd/server.js" type="module"></script>
    <script type="module">
      import { SignUp } from "../BackEnd/server.js";
      import {initializeApp} from "https://www.gstatic.com/firebasejs/9.1.1/firebase-app.js";
      import {signInWithEmailAndPassword, sendPasswordResetEmail, RecaptchaVerifier, createUserWithEmailAndPassword, getAuth, signInWithPhoneNumber} from "https://www.gstatic.com/firebasejs/9.1.1/firebase-auth.js"

      const firebaseConfig = {
          apiKey: "AIzaSyAT08qUZxvau0g2qIL7wC3d14r9Q8vyuRc",
          authDomain: "international-school-f8cd0.firebaseapp.com",
          databaseURL: "https://international-school-f8cd0-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "international-school-f8cd0",
          storageBucket: "international-school-f8cd0.appspot.com",
          messagingSenderId: "478948302270",
          appId: "1:478948302270:web:66a027800a1342107e6def",
          measurementId: "G-Q0LFLRM7ZK"
        };

      initializeApp(firebaseConfig);

      const auth = getAuth();

      // Get the form element
      const loginForm = document.getElementById("Login");
      const errorMessage = document.getElementById("errorMessage");

      function async_signup(response){
        // Add event listener to the submit button
        loginForm.addEventListener("submit", (event) => {
          event.preventDefault(); // Prevent form submission

          // Get the username and password values
          const password = document.getElementById("password").value;
          const confirm_password = document.getElementById("confirm_password").value;
          const phoneNo = document.getElementById("phone").value;
          const admission_no = document.getElementById("admissonNo").value;

          // Validate the password
          if (password!== confirm_password) {
            errorMessage.textContent = "Passwords do not match";
            errorMessage.style.display = "block";
            return;
          }

          const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
          if (!passwordRegex.test(password)) {
            errorMessage.textContent = "Password must be at least 8 characters long and contain at least one uppercase letter, one lowercase letter, one number, and one special character";
            errorMessage.style.display = "block";
            return;
          }

          //If Fields is empty
          if (!password ||!confirm_password ||!phoneNo ||!admission_no) {
            errorMessage.textContent = "All fields are required";
            errorMessage.style.display = "block";
            return;
          }

          //Check if Phone No is 10 digits with + state code ex - +91 as first 1 or 2 digits
          const phoneRegex = /\+\d\d\d\d\d\d\d\d\d\d/;
          if (!phoneRegex.test(phoneNo)) {
            errorMessage.textContent = "Invalid Phone Number";
            errorMessage.style.display = "block";
            return;
          }

          errorMessage.style.display = "none"; // Hide error message if not any
          
          try{
            SignUp(admission_no, password, errorMessage, "index.html", true, phoneNo, window.recaptchaVerifier);
          } catch(error) {
            errorMessage.textContent = "Signup failed";
            errorMessage.style.display = "block";
            console.log(error)
          }
          // Do something with the username and password
          console.log("Admission No:", admission_no);
          console.log("Password:", password);
          console.log("Phone Number:", phoneNo);
          console.log("Admission Number:", admission_no);
        });

        // You can perform further validation or send the data to a server for authentication
      };

      window.recaptchaVerifier = new RecaptchaVerifier("re-CAPTCHA", {
        "size": "normal",
        "callback": async_signup,
      }, auth);

      window.recaptchaVerifier.render();
    </script>
    <script src="https://www.google.com/recaptcha/api.js?onload=onCaptchaLoad&render=6LeDzS8qAAAAAFn49cRUgNPN-D3oRno9CTHJ9Mla"></script>
  </body>
</html>
